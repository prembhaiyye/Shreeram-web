{% extends "base.html" %}

{% block content %}
<h1 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Dashboard</h1>

<div class="card-grid">
    <!-- Temperature -->
    <a href="{{ url_for('views.graph', sensor_type='temperature') }}" class="card theme-temp" id="card-temperature">
        <span class="bg-icon">ğŸŒ¡ï¸</span>
        <div class="card-header">
            <span class="card-title">Temperature</span>
            <span class="indicator indicator-green" id="ind-temperature"></span>
        </div>
        <div>
            <span class="card-value" id="val-temperature">--</span>
            <span class="card-unit">Â°C</span>
        </div>
    </a>

    <!-- Humidity -->
    <a href="{{ url_for('views.graph', sensor_type='humidity') }}" class="card theme-water" id="card-humidity">
        <span class="bg-icon">ğŸ’§</span>
        <div class="card-header">
            <span class="card-title">Humidity</span>
            <span class="indicator indicator-green" id="ind-humidity"></span>
        </div>
        <div>
            <span class="card-value" id="val-humidity">--</span>
            <span class="card-unit">%</span>
        </div>
    </a>

    <!-- pH -->
    <a href="{{ url_for('views.graph', sensor_type='ph') }}" class="card theme-nutrient" id="card-ph">
        <span class="bg-icon">ğŸ§ª</span>
        <div class="card-header">
            <span class="card-title">pH</span>
            <span class="indicator indicator-green" id="ind-ph"></span>
        </div>
        <div>
            <span class="card-value" id="val-ph">--</span>
            <span class="card-unit">pH</span>
        </div>
    </a>

    <!-- TDS -->
    <a href="{{ url_for('views.graph', sensor_type='tds') }}" class="card theme-nutrient" id="card-tds">
        <span class="bg-icon">ğŸ§‚</span>
        <div class="card-header">
            <span class="card-title">TDS</span>
            <span class="indicator indicator-green" id="ind-tds"></span>
        </div>
        <div>
            <span class="card-value" id="val-tds">--</span>
            <span class="card-unit">ppm</span>
        </div>
    </a>

    <!-- Nitrogen -->
    <a href="{{ url_for('views.graph', sensor_type='n') }}" class="card theme-nutrient" id="card-n">
        <span class="bg-icon">ğŸŒ¿</span>
        <div class="card-header">
            <span class="card-title">Nitrogen (N)</span>
            <span class="indicator indicator-green" id="ind-n"></span>
        </div>
        <div>
            <span class="card-value" id="val-n">--</span>
            <span class="card-unit">mg/kg</span>
        </div>
    </a>

    <!-- Phosphorus -->
    <a href="{{ url_for('views.graph', sensor_type='p') }}" class="card theme-nutrient" id="card-p">
        <span class="bg-icon">ğŸ§¬</span>
        <div class="card-header">
            <span class="card-title">Phosphorus (P)</span>
            <span class="indicator indicator-green" id="ind-p"></span>
        </div>
        <div>
            <span class="card-value" id="val-p">--</span>
            <span class="card-unit">mg/kg</span>
        </div>
    </a>

    <!-- Potassium -->
    <a href="{{ url_for('views.graph', sensor_type='k') }}" class="card theme-nutrient" id="card-k">
        <span class="bg-icon">ğŸŒ</span>
        <div class="card-header">
            <span class="card-title">Potassium (K)</span>
            <span class="indicator indicator-green" id="ind-k"></span>
        </div>
        <div>
            <span class="card-value" id="val-k">--</span>
            <span class="card-unit">mg/kg</span>
        </div>
    </a>

    <!-- Light -->
    <a href="{{ url_for('views.graph', sensor_type='light') }}" class="card theme-light" id="card-light">
        <span class="bg-icon">â˜€ï¸</span>
        <div class="card-header">
            <span class="card-title">Light Intensity</span>
            <span class="indicator indicator-green" id="ind-light"></span>
        </div>
        <div>
            <span class="card-value" id="val-light">--</span>
            <span class="card-unit">lux</span>
        </div>
    </a>

    <!-- Water Level -->
    <a href="{{ url_for('views.graph', sensor_type='water_level') }}" class="card theme-water" id="card-water_level">
        <span class="bg-icon">ğŸŒŠ</span>
        <div class="card-header">
            <span class="card-title">Water Level</span>
            <span class="indicator indicator-green" id="ind-water_level"></span>
        </div>
        <div>
            <span class="card-value" id="val-water_level">--</span>
            <span class="card-unit">%</span>
        </div>
    </a>

    <!-- CPU Temp -->
    <a href="{{ url_for('views.graph', sensor_type='cpu_temp') }}" class="card theme-temp" id="card-cpu_temp">
        <span class="bg-icon">ğŸ’»</span>
        <div class="card-header">
            <span class="card-title">CPU Temp</span>
            <span class="indicator indicator-green" id="ind-cpu_temp"></span>
        </div>
        <div>
            <span class="card-value" id="val-cpu_temp">--</span>
            <span class="card-unit">Â°C</span>
        </div>
    </a>


    <!-- Gas Status -->
    <a href="{{ url_for('views.graph', sensor_type='gas') }}" class="card theme-warning" id="card-gas">
        <span class="bg-icon">âš ï¸</span>
        <div class="card-header">
            <span class="card-title">Gas Status</span>
            <span class="indicator indicator-green" id="ind-gas"></span>
        </div>
        <div>
            <span class="card-value" id="val-gas">OK</span>
            <span class="card-unit"></span>
        </div>
    </a>

</div>
{% endblock %}

{% block scripts %}
<script>
    function getStatusClass(type, value) {
        let val = parseFloat(value);
        if (isNaN(val)) return '';

        // Thresholds
        // Temp: <15(Red), 15-35(Green), >35(Red)
        // Humidity: <30(Red), 30-80(Green), >80(Red) for visual pop

        switch (type) {
            case 'temperature':
                if (val < 15 || val > 35) return 'card-status-danger';
                if (val < 18 || val > 30) return 'card-status-warning';
                return 'card-status-ok';
            case 'humidity':
                if (val < 30 || val > 80) return 'card-status-danger';
                if (val < 40 || val > 70) return 'card-status-warning';
                return 'card-status-ok';
            case 'ph':
                if (val < 5.0 || val > 7.5) return 'card-status-danger';
                if (val < 5.5 || val > 6.5) return 'card-status-warning';
                return 'card-status-ok';
            case 'tds':
                if (val < 200 || val > 1500) return 'card-status-danger';
                if (val < 400 || val > 1200) return 'card-status-warning';
                return 'card-status-ok';
            case 'n':
            case 'p':
            case 'k':
                if (val < 50 || val > 300) return 'card-status-danger';
                return 'card-status-ok';
            case 'light':
                if (val < 1000) return 'card-status-warning';
                return 'card-status-ok';
            case 'water_level':
                if (val < 20) return 'card-status-danger';
                if (val < 40) return 'card-status-warning';
                return 'card-status-ok';
            case 'cpu_temp':
                if (val > 70) return 'card-status-danger';
                if (val > 60) return 'card-status-warning';
                return 'card-status-ok';
            default:
                return '';
        }
    }

    function updateCardColors(data) {
        for (const [key, value] of Object.entries(data)) {
            const card = document.getElementById(`card-${key}`);
            if (card) {
                card.classList.remove('card-status-ok', 'card-status-warning', 'card-status-danger');
                const statusClass = getStatusClass(key, value);
                if (statusClass) card.classList.add(statusClass);
            }
        }
    }

    async function fetchSensorData() {
        try {
            // Trying standard endpoint. If this fails, I'll need to debug. 
            // Assuming '/api/data' or similar based on typical convention. 
            // But wait, the previous code called it `fetchSensorData` which implies it might be defined in `main.js`. 
            // I will assume `main.js` handles the fetch and returns data, OR I explicitly fetch here.
            // Let's rely on `main.js` IF it exposes the data logic. 
            // But to be safe and independent:
            const response = await fetch('/api/sensors/latest'); // Guessing endpoint
            if (!response.ok) throw new Error('API fetch failed');
            const data = await response.json();

            for (const [key, value] of Object.entries(data)) {
                const valElem = document.getElementById(`val-${key}`);
                const indElem = document.getElementById(`ind-${key}`);

                if (valElem) valElem.textContent = value;
                // Simple indicator logic (green if data present)
                if (indElem) {
                    indElem.classList.remove('indicator-red', 'indicator-green');
                    indElem.classList.add('indicator-green');
                }
            }

            // Update Colors
            updateCardColors(data);

        } catch (e) {
            console.error("Fetch error", e);
        }
    }

    // Start Polling
    fetchSensorData();
    setInterval(fetchSensorData, 2000); 
</script>
{% endblock %}