{% extends "base.html" %}

{% block content %}
<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
    <a href="{{ url_for('views.monitor') }}" class="btn"
        style="width: auto; padding: 0.5rem 1rem; background: transparent; color: var(--text-secondary);">‚Üê Back</a>
    <h1 style="text-transform: capitalize;">{{ sensor_type }} History</h1>
</div>

<!-- Controls Section -->
<h3 style="margin-bottom: 1rem;">Controls</h3>
<div class="card-grid" style="margin-bottom: 2rem;">
    {% for control in controls %}
    {% set icon_off = 'üîå' %}
    {% set icon_on = '‚ö°' %}

    {% if 'pump' in control.name %}
    {% set icon_off = 'üö∞' %}
    {% set icon_on = 'üåä' %}
    {% elif 'fan' in control.name %}
    {% set icon_off = 'üõë' %}
    {% set icon_on = 'üí®' %}
    {% elif 'light' in control.name %}
    {% set icon_off = 'üåë' %}
    {% set icon_on = 'üí°' %}
    {% elif 'motor' in control.name %}
    {% set icon_off = '‚öôÔ∏è' %}
    {% set icon_on = 'üîÑ' %}
    {% endif %}

    <div class="card {{ 'card-on' if control.is_on else 'card-off' }}" id="card-{{ control.name }}"
        data-icon-on="{{ icon_on }}" data-icon-off="{{ icon_off }}"
        style="align-items: center; justify-content: center; text-align: center; gap: 0.5rem;">

        <span class="bg-icon" id="icon-{{ control.name }}">
            {{ icon_on if control.is_on else icon_off }}
        </span>

        <span class="card-title" style="text-transform: capitalize; font-size: 0.9rem;">{{ control.name.replace('_', '
            ') }}</span>

        <div class="status-badge {{ 'status-online' if control.is_on else 'status-offline' }}"
            id="badge-{{ control.name }}">
            {{ 'ON' if control.is_on else 'OFF' }}
        </div>

        <label class="switch" style="margin-top: 0.5rem;">
            <input type="checkbox" onchange="toggleControl('{{ control.name }}', this.checked)" {{ 'checked' if
                control.is_on else '' }}>
            <span class="slider round"></span>
        </label>
    </div>
    {% endfor %}
</div>

<div class="card" style="aspect-ratio: auto; height: auto;">
    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="btn" style="width: auto; font-size: 0.8rem; padding: 0.25rem 0.5rem;">1H</button>
        <button class="btn btn-primary" style="width: auto; font-size: 0.8rem; padding: 0.25rem 0.5rem;">24H</button>
        <button class="btn" style="width: auto; font-size: 0.8rem; padding: 0.25rem 0.5rem;">1W</button>
        <button class="btn" style="width: auto; font-size: 0.8rem; padding: 0.25rem 0.5rem;">1M</button>
    </div>
    <canvas id="sensorChart" width="400" height="200"></canvas>
</div>

<div class="card-grid" style="margin-top: 1.5rem; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
    <div class="card card-sm" style="text-align: center;">
        <div class="card-title card-title-sm">Highest</div>
        <div class="card-value card-value-sm">28.5</div>
    </div>
    <div class="card card-sm" style="text-align: center;">
        <div class="card-title card-title-sm">Lowest</div>
        <div class="card-value card-value-sm">22.1</div>
    </div>
    <div class="card card-sm" style="text-align: center;">
        <div class="card-title card-title-sm">Average</div>
        <div class="card-value card-value-sm">25.3</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleControl(name, state) {
        // Optimistic UI update
        const badge = document.getElementById(`badge-${name}`);
        const card = document.getElementById(`card-${name}`);
        const iconSpan = document.getElementById(`icon-${name}`);

        if (state) {
            badge.textContent = 'ON';
            badge.classList.remove('status-offline');
            badge.classList.add('status-online');

            if (card) {
                card.classList.remove('card-off');
                card.classList.add('card-on'); // Green state

                // Switch Icon
                const onIcon = card.getAttribute('data-icon-on');
                if (onIcon && iconSpan) iconSpan.textContent = onIcon;
            }
        } else {
            badge.textContent = 'OFF';
            badge.classList.remove('status-online');
            badge.classList.add('status-offline');

            if (card) {
                card.classList.remove('card-on');
                card.classList.add('card-off'); // Grey state

                // Switch Icon
                const offIcon = card.getAttribute('data-icon-off');
                if (offIcon && iconSpan) iconSpan.textContent = offIcon;
            }
        }

        try {
            const response = await fetch('/api/controls', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, state: state })
            });
            const result = await response.json();
            if (!result.success) {
                // Revert if failed
                alert('Failed to toggle control');
                location.reload();
            }
        } catch (e) {
            console.error(e);
            alert('Network error');
        }
    }

    const ctx = document.getElementById('sensorChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
            datasets: [{
                label: '{{ sensor_type|capitalize }}',
                data: [22, 23, 25, 28, 27, 24, 23], // Dummy data
                borderColor: '#3182ce',
                backgroundColor: 'rgba(49, 130, 206, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
</script>
{% endblock %}