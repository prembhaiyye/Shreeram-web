{% extends "base.html" %}

{% block content %}
<h1 style="margin-bottom: 1.5rem;">Controls</h1>

<div class="card-grid">
    {% for control in controls %}
    <div class="card" id="card-{{ control.name }}">
        <div class="card-header">
            <span class="card-title" style="text-transform: capitalize;">{{ control.name.replace('_', ' ') }}</span>
            <div class="status-badge {{ 'status-online' if control.is_on else 'status-offline' }}"
                id="badge-{{ control.name }}">
                {{ 'ON' if control.is_on else 'OFF' }}
            </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
            <span>Toggle State</span>
            <label class="switch">
                <input type="checkbox" onchange="toggleControl('{{ control.name }}', this.checked)" {{ 'checked' if
                    control.is_on else '' }}>
                <span class="slider round"></span>
            </label>
        </div>

        <!-- Special controls for Grow Light -->
        {% if control.name == 'grow_light' %}
        <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
            <div style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">Intensity</div>
            <input type="range" min="0" max="100" value="50" style="width: 100%;">

            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                <button class="btn" style="font-size: 0.8rem; padding: 0.5rem;">Vegetative</button>
                <button class="btn" style="font-size: 0.8rem; padding: 0.5rem;">Flowering</button>
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleControl(name, state) {
        // Optimistic UI update
        const badge = document.getElementById(`badge-${name}`);
        const card = document.getElementById(`card-${name}`);

        if (state) {
            badge.textContent = 'ON';
            badge.classList.remove('status-offline');
            badge.classList.add('status-online');
            // card.style.borderColor = 'var(--success-color)'; // Optional visual cue
        } else {
            badge.textContent = 'OFF';
            badge.classList.remove('status-online');
            badge.classList.add('status-offline');
        }

        try {
            const response = await fetch('/api/controls', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, state: state })
            });
            const result = await response.json();
            if (!result.success) {
                // Revert if failed
                alert('Failed to toggle control');
                location.reload();
            }
        } catch (e) {
            console.error(e);
            alert('Network error');
        }
    }
</script>
{% endblock %}